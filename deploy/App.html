<!DOCTYPE html>
<html>
<head>
    <title>Project Scope</title>

    <script type="text/javascript" src="/apps/2.0rc1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",launch:function(){MyApp=this,MyApp.epicList=[],MyApp.scopeDetails=[],MyApp.scopeDescription=[],MyApp.featureDetails=[],MyApp.featureDescription=[],MyApp.globalContext=this.getContext().getDataContext(),MyApp._loadProgramList()},_wrapComponent:function(component,cls){var wrapper=Ext.create("Ext.container.Container",{componentCls:cls});return wrapper.add(component),wrapper},_loadProgramList:function(){var thisIsMyStore=Ext.create("Rally.data.WsapiDataStore",{autoLoad:!0,model:"PortfolioItem/Epic",context:MyApp.globalContext,sorters:{property:"Name",direction:"ASC"},listeners:{load:function(store,records){console.log(store);var index=0;for(index=0;records.length>index;index++)MyApp.epicList.push(records[index].data.Name);MyApp._drawComboBox()}}})},_drawComboBox:function(){MyApp.combo=Ext.create("Ext.form.ComboBox",{fieldLabel:"Program",store:MyApp.epicList,listeners:{change:function(combo,newVal){MyApp.selectedEpicName=newVal,MyApp._loadProgramDetails()}}}),MyApp.programPane=Ext.create("Ext.container.Container",{componentCls:"inner"}),MyApp.add(MyApp._wrapComponent(MyApp.programPane,"program")),MyApp.programPane.add(MyApp.combo)},_loadProgramDetails:function(){Ext.create("Rally.data.WsapiDataStore",{autoLoad:!0,model:"PortfolioItem/Epic",context:MyApp.globalContext,fetch:["Name","c_SAPProjectNumber","InvestmentCategory","PlannedStartDate","PlannedEndDate","LastUpdateDate","Description"],filters:[{property:"Name",operator:"Contains",value:MyApp.selectedEpicName}],sorters:{property:"Rank",direction:"ASC"},listeners:{load:MyApp._writeProgramDetails}})},_writeProgramDetails:function(myStore,records){MyApp.programPane.remove(MyApp.combo),title=records[0].data.Name,MyApp.programName=Ext.create("Ext.panel.Panel",{width:"100%",html:"<p><h1><a href='"+Rally.nav.Manager.getDetailUrl(records[0])+"'>"+title+"</a></h1></p>",renderTo:Ext.getBody()}),MyApp.programPane.add(MyApp.programName),MyApp.programDetails=Ext.create("Rally.ui.grid.Grid",{store:myStore,border:1,columnCfgs:[{dataIndex:"c_SAPProjectNumber",text:"SAP #"},"InvestmentCategory","PlannedStartDate","PlannedEndDate","LastUpdateDate"],showPagingToolbar:!1}),MyApp.programPane.add(MyApp.programDetails),MyApp.programDescription=Ext.create("Ext.panel.Panel",{width:"100%",html:"<p>"+records[0].data.Description+"</p>",renderTo:Ext.getBody()}),MyApp.programPane.add(MyApp.programDescription),MyApp.scopePane=Ext.create("Ext.container.Container",{componentCls:"inner"}),MyApp.add(MyApp._wrapComponent(MyApp.scopePane,"scope")),MyApp.scopeTotal=Ext.create("Ext.panel.Panel",{width:"100%",html:"<p><h2>Scope Summary</h2></p>",renderTo:Ext.getBody()}),MyApp.scopePane.add(MyApp.scopeTotal),MyApp._loadScopeDetails()},_loadScopeDetails:function(){Ext.create("Rally.data.WsapiDataStore",{autoLoad:!0,pageSize:1,limit:1,model:"PortfolioItem/MMF",context:MyApp.globalContext,fetch:["Parent","Project","Name","c_SAPProjectNumber","InvestmentCategory","PlannedStartDate","PlannedEndDate","LastUpdateDate","Description"],filters:[{property:"Parent.Name",operator:"Contains",value:MyApp.selectedEpicName}],sorters:{property:"Rank",direction:"ASC"},listeners:{load:function(store,records){if(MyApp._buildScopeDetails(store,records,store.currentPage-1),store.currentPage<store.totalCount)store.loadPage(store.currentPage+1);else{var index=0;for(index=0;store.totalCount>index;index++)MyApp.scopePane.add(MyApp.scopeDetails[index]),MyApp.scopePane.add(MyApp.scopeDescription[index]);MyApp.featurePane=Ext.create("Ext.container.Container",{componentCls:"inner"}),MyApp.add(MyApp._wrapComponent(MyApp.featurePane,"feature")),MyApp.featureTotal=Ext.create("Ext.panel.Panel",{width:"100%",html:"<p><h2>Feature Summary by PSI</h2></p>",renderTo:Ext.getBody()}),MyApp.featurePane.add(MyApp.featureTotal),MyApp._loadFeatureDetails()}}}})},_buildScopeDetails:function(myStore,records){var epicTitle=MyApp.selectedEpicName+": ",title=records[0].data.Name;0===title.indexOf(epicTitle)&&(title=title.substr(epicTitle.length)),MyApp.scopeDetails.push(Ext.create("Rally.ui.grid.Grid",{store:myStore,title:"<a href='"+Rally.nav.Manager.getDetailUrl(records[0])+"'>"+title+"</a>",border:1,columnCfgs:["Name",{dataIndex:"c_SAPProjectNumber",text:"SAP #"},"InvestmentCategory","PlannedStartDate","PlannedEndDate","LastUpdateDate","Project"],showPagingToolbar:!1})),MyApp.scopeDescription.push(Ext.create("Ext.panel.Panel",{width:"100%",html:"<p>"+records[0].data.Description+"</p>",renderTo:Ext.getBody()}))},_loadFeatureDetails:function(){Ext.create("Rally.data.WsapiDataStore",{autoLoad:!0,pageSize:1,limit:1,model:"PortfolioItem/Feature",context:MyApp.globalContext,fetch:["Parent","Project","Name","PreliminaryEstimate","ValueScore","RiskScore","LastUpdateDate","Description","Release"],filters:[{property:"Parent.Parent.Name",operator:"Contains",value:MyApp.selectedEpicName}],sorters:{property:"Release",direction:"ASC"},listeners:{load:function(store,records){if(MyApp._writeFeatureDetails(store,records),store.currentPage<store.totalCount)store.loadPage(store.currentPage+1);else{var index=0;for(index=0;store.totalCount>index;index++)MyApp.featurePane.add(MyApp.featureDetails[index]),MyApp.featurePane.add(MyApp.featureDescription[index])}}}})},_writeFeatureDetails:function(myStore,records){var title=records[0].data.Name;MyApp.featureDetails.push(Ext.create("Rally.ui.grid.Grid",{store:myStore,border:1,title:"<a href='"+Rally.nav.Manager.getDetailUrl(records[0])+"'>"+title+"</a>",columnCfgs:["Name","PreliminaryEstimate","ValueScore","RiskScore","Project","LastUpdateDate","Release"],showPagingToolbar:!1})),MyApp.featureDescription.push(Ext.create("Ext.panel.Panel",{width:"100%",html:"<p>"+records[0].data.Description+"</p>",renderTo:Ext.getBody()}))}});

            Rally.launchApp('CustomApp', {
                name:"Project Scope",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        .app {
     /* Add app styles here */
}

.inner {
    padding: 10px;
}

.program {
    float: left;
    width: 100%;
}

.scope {
    float: left;
    width: 100%;
}

.feature {
    float: left;
    width: 100%;
}
    </style>
</head>
<body></body>
</html>
